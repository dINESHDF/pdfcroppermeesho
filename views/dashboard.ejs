<%- include('header', { title: 'Dashboard - PDF Crop Pro', bodyClass: 'bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen' }) %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
.pdf-viewer-card {
  transition: all 0.3s ease;
}
.pdf-viewer-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 15px 30px rgba(30, 58, 138, 0.2);
}
.badge-coming-soon {
  background: linear-gradient(135deg, #f59e0b, #ef4444);
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
.platform-card {
  transition: all 0.3s ease;
  cursor: pointer;
}
.platform-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 25px rgba(30, 58, 138, 0.15);
}
.platform-card.selected {
  border-color: #1e3a8a;
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
}
.gradient-bg {
  background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
}
</style>

<div class="max-w-7xl mx-auto px-6 py-8 pb-24">

  <div class="flex flex-col lg:flex-row gap-6">
    <!-- Left Section -->
    <div class="flex-1 lg:w-0 space-y-6">
      <!-- Upload Section -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-blue-100">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <i data-lucide="upload-cloud" class="w-6 h-6 text-blue-900"></i>
            <h2 class="text-2xl font-bold text-blue-900">Upload PDFs</h2>
          </div>
          <span class="text-xs bg-blue-100 text-blue-900 px-3 py-1 rounded-full font-semibold">Max 10 files</span>
        </div>
        
        <div id="upload-area" class="border-4 border-dashed border-blue-200 rounded-xl p-10 text-center cursor-pointer hover:border-blue-900 hover:bg-blue-50 transition-all">
          <i data-lucide="file-plus" class="w-20 h-20 mx-auto mb-4 text-blue-400"></i>
          <h3 class="text-2xl font-semibold text-blue-900 mb-2">Drag & Drop Here</h3>
          <p class="text-gray-600 mb-4">or click to browse (Multiple files supported)</p>
          <button type="button" id="browse-btn" class="gradient-bg text-white px-8 py-3 rounded-xl font-bold hover:shadow-xl transition-all inline-flex items-center space-x-2">
            <i data-lucide="folder-open" class="w-5 h-5"></i>
            <span>Browse Files</span>
          </button>
          <input type="file" id="pdf-input" accept="application/pdf" multiple class="hidden">
        </div>
        
        <div id="file-list" class="mt-6 hidden">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold text-blue-900 flex items-center space-x-2">
              <i data-lucide="files" class="w-5 h-5 text-blue-900"></i>
              <span>Selected: <span id="file-count" class="text-blue-600">0</span></span>
            </h3>
            <button id="clear-files-btn" class="text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg font-medium transition-all flex items-center space-x-2">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
              <span>Clear</span>
            </button>
          </div>
          <div id="files-container" class="space-y-3 max-h-60 overflow-y-auto"></div>
        </div>
      </div>

      <!-- PDF Viewer -->
      <div id="pdf-viewer-section" class="bg-white rounded-2xl shadow-xl p-6 border border-blue-100 hidden">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-bold text-blue-900 flex items-center space-x-2">
            <i data-lucide="eye" class="w-6 h-6 text-blue-900"></i>
            <span>Preview</span>
          </h3>
          <span class="bg-green-100 text-green-700 px-4 py-2 rounded-full font-bold flex items-center space-x-2">
            <i data-lucide="check" class="w-4 h-4"></i>
            <span id="total-files">0</span> Ready
          </span>
        </div>
        <div id="pdf-preview-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div id="loading-indicator" class="text-center py-16 hidden">
          <div class="inline-block animate-spin rounded-full h-20 w-20 border-4 border-blue-900 border-t-transparent mb-4"></div>
          <p class="text-blue-900 text-xl font-bold">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="w-full lg:w-80 xl:w-96 flex-shrink-0 space-y-6">
      <!-- Platform Selection -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-blue-100">
        <div class="flex items-center space-x-2 mb-6 pb-4 border-b-2 border-blue-100">
          <i data-lucide="package" class="w-6 h-6 text-blue-900"></i>
          <h2 class="text-xl font-bold text-blue-900">Select Platform</h2>
        </div>

        <div id="platform-cards" class="space-y-3">
          <div class="platform-card border-2 border-blue-200 rounded-xl p-4 flex items-center space-x-3" data-platform="meesho">
            <img src="/images/meesho.png" alt="Meesho" class="w-12 h-12 object-contain" onerror="this.style.display='none'">
            <div class="flex-1">
              <p class="font-bold text-blue-900">Meesho</p>
              <p class="text-xs text-gray-500">Smart label cropping</p>
            </div>
            <i data-lucide="check-circle" class="w-6 h-6 text-blue-900 hidden check-icon"></i>
          </div>

          <div class="platform-card border-2 border-blue-200 rounded-xl p-4 flex items-center space-x-3" data-platform="flipkart">
            <img src="/images/flipkart.png" alt="Flipkart" class="w-12 h-12 object-contain" onerror="this.style.display='none'">
            <div class="flex-1">
              <p class="font-bold text-blue-900">Flipkart</p>
              <p class="text-xs text-gray-500">Precise crop zones</p>
            </div>
            <i data-lucide="check-circle" class="w-6 h-6 text-blue-900 hidden check-icon"></i>
          </div>

          <div class="platform-card border-2 border-blue-200 rounded-xl p-4 flex items-center space-x-3" data-platform="amazon">
            <img src="/images/amazon.png" alt="Amazon" class="w-12 h-12 object-contain" onerror="this.style.display='none'">
            <div class="flex-1">
              <p class="font-bold text-blue-900">Amazon</p>
              <p class="text-xs text-gray-500">Optimized labels</p>
            </div>
            <i data-lucide="check-circle" class="w-6 h-6 text-blue-900 hidden check-icon"></i>
          </div>

          <div class="platform-card border-2 border-blue-200 rounded-xl p-4 flex items-center space-x-3" data-platform="citymall">
            <img src="/images/citymall.png" alt="Citymall" class="w-12 h-12 object-contain" onerror="this.style.display='none'">
            <div class="flex-1">
              <p class="font-bold text-blue-900">Citymall</p>
              <p class="text-xs text-gray-500">Custom cropping</p>
            </div>
            <i data-lucide="check-circle" class="w-6 h-6 text-blue-900 hidden check-icon"></i>
          </div>

          <div class="platform-card border-2 border-blue-200 rounded-xl p-4 flex items-center space-x-3" data-platform="custom">
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <i data-lucide="settings" class="w-6 h-6 text-blue-900"></i>
            </div>
            <div class="flex-1">
              <p class="font-bold text-blue-900">Custom</p>
              <p class="text-xs text-gray-500">Manual settings</p>
            </div>
            <i data-lucide="check-circle" class="w-6 h-6 text-blue-900 hidden check-icon"></i>
          </div>
        </div>

        <input type="hidden" id="platform-select" name="platform" value="meesho">
      </div>

      <!-- Settings -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-blue-100">
        <div class="flex items-center space-x-2 mb-6 pb-4 border-b-2 border-blue-100">
          <i data-lucide="settings" class="w-6 h-6 text-blue-900"></i>
          <h2 class="text-xl font-bold text-blue-900">Settings</h2>
        </div>

        <form id="process-form" class="space-y-4">
          <div class="flex items-start space-x-3 p-3 rounded-xl hover:bg-blue-50 transition-all">
            <input type="checkbox" id="merge-pdf" name="mergePdf" class="w-5 h-5 mt-0.5 text-blue-900 rounded flex-shrink-0">
            <div class="flex-1">
              <label for="merge-pdf" class="font-bold text-blue-900 cursor-pointer flex items-center">
                <i data-lucide="combine" class="w-4 h-4 mr-2 text-blue-900"></i>Merge PDFs
              </label>
              <p class="text-xs text-gray-500 mt-1">Combine all into one</p>
            </div>
          </div>

          <div class="flex items-start space-x-3 p-3 rounded-xl hover:bg-blue-50 transition-all">
            <input type="checkbox" id="add-datetime" name="addDateTime" class="w-5 h-5 mt-0.5 text-blue-900 rounded flex-shrink-0">
            <div class="flex-1">
              <label for="add-datetime" class="font-bold text-blue-900 cursor-pointer flex items-center">
                <i data-lucide="calendar-clock" class="w-4 h-4 mr-2 text-blue-900"></i>Add Date/Time
              </label>
              <p class="text-xs text-gray-500 mt-1">Timestamp pages</p>
            </div>
          </div>

          <div class="flex items-start space-x-3 p-3 rounded-xl hover:bg-blue-50 transition-all border-2 border-blue-200 bg-blue-50">
            <input type="checkbox" id="sort-sku" name="sortSku" class="w-5 h-5 mt-0.5 text-blue-900 rounded flex-shrink-0" checked>
            <div class="flex-1">
              <label for="sort-sku" class="font-bold text-blue-900 cursor-pointer flex items-center">
                <i data-lucide="arrow-down-a-z" class="w-4 h-4 mr-2 text-blue-900"></i>Sort by SKU
              </label>
              <p class="text-xs text-gray-500 mt-1">Alphabetically organize labels</p>
            </div>
          </div>

          <div class="flex items-start space-x-3 p-3 rounded-xl hover:bg-orange-50 transition-all opacity-60">
            <input type="checkbox" id="keep-invoice" name="keepInvoice" class="w-5 h-5 mt-0.5 rounded flex-shrink-0" disabled>
            <div class="flex-1">
              <label class="font-bold text-gray-700 flex items-center justify-between">
                <span class="flex items-center"><i data-lucide="file-check" class="w-4 h-4 mr-2 text-blue-900"></i>Keep Invoice</span>
                <span class="badge-coming-soon text-white text-xs px-2 py-1 rounded-full">Soon</span>
              </label>
              <p class="text-xs text-gray-500 mt-1">Preserve invoices</p>
            </div>
          </div>

          <div class="flex items-start space-x-3 p-3 rounded-xl hover:bg-blue-50 transition-all">
            <input type="checkbox" id="add-text" name="addText" class="w-5 h-5 mt-0.5 text-blue-900 rounded flex-shrink-0">
            <div class="flex-1">
              <label for="add-text" class="font-bold text-blue-900 cursor-pointer flex items-center">
                <i data-lucide="type" class="w-4 h-4 mr-2 text-blue-900"></i>Custom Text
              </label>
              <input type="text" id="custom-text" name="customText" placeholder="Enter text..." class="mt-2 w-full px-3 py-2 border-2 border-blue-200 rounded-lg text-sm focus:border-blue-900 outline-none" disabled>
            </div>
          </div>

          <div class="flex items-start space-x-3 p-3 rounded-xl hover:bg-orange-50 transition-all opacity-60">
            <input type="checkbox" id="multi-orders" name="multiOrders" class="w-5 h-5 mt-0.5 rounded flex-shrink-0" disabled>
            <div class="flex-1">
              <label class="font-bold text-gray-700 flex items-center justify-between">
                <span class="flex items-center"><i data-lucide="layers" class="w-4 h-4 mr-2 text-blue-900"></i>Multi Orders</span>
                <span class="badge-coming-soon text-white text-xs px-2 py-1 rounded-full">Soon</span>
              </label>
              <p class="text-xs text-gray-500 mt-1">Reorder last</p>
            </div>
          </div>

          <div class="p-4 bg-blue-50 rounded-xl">
            <label class="font-bold text-blue-900 flex justify-between mb-3">
              <span class="flex items-center"><i data-lucide="maximize" class="w-4 h-4 mr-2 text-blue-900"></i>Margin</span>
              <span id="margin-display" class="text-blue-600 text-xl">50px</span>
            </label>
            <input type="range" id="margin-slider" name="margin" min="0" max="100" value="50" class="w-full h-3 bg-gradient-to-r from-blue-200 to-blue-900 rounded-full">
          </div>

          <button type="submit" id="process-btn" disabled class="w-full gradient-bg text-white py-4 rounded-xl font-bold text-xl hover:shadow-2xl transition-all flex items-center justify-center space-x-2 disabled:opacity-50 transform hover:-translate-y-1">
            <i data-lucide="scissors" class="w-6 h-6"></i>
            <span>Process</span>
          </button>

          <div id="processing-status" class="hidden text-center py-8 bg-blue-50 rounded-xl">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-900 border-t-transparent mb-3"></div>
            <p class="text-blue-900 font-bold text-lg">Processing...</p>
          </div>
        </form>
      </div>

      <!-- Downloads -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-blue-100">
        <div class="flex items-center space-x-2 mb-4 pb-3 border-b-2 border-blue-100">
          <i data-lucide="download" class="w-5 h-5 text-blue-900"></i>
          <h3 class="text-lg font-bold text-blue-900">Downloads</h3>
        </div>
        <div id="downloads-list" class="space-y-3 max-h-96 overflow-y-auto">
          <div class="text-center text-gray-400 py-16">
            <i data-lucide="inbox" class="w-20 h-20 mx-auto mb-3"></i>
            <p class="font-semibold">No downloads yet</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  lucide.createIcons();

  let selectedFiles = [];
  let pdfData = [];
  let downloads = JSON.parse(localStorage.getItem('pdfDownloads') || '[]');

  const uploadArea = document.getElementById('upload-area');
  const pdfInput = document.getElementById('pdf-input');
  const processBtn = document.getElementById('process-btn');
  const processForm = document.getElementById('process-form');
  const marginSlider = document.getElementById('margin-slider');
  const marginDisplay = document.getElementById('margin-display');
  const addTextCheckbox = document.getElementById('add-text');
  const customTextInput = document.getElementById('custom-text');
  const platformSelect = document.getElementById('platform-select');

  // Platform card selection
  document.querySelectorAll('.platform-card').forEach(card => {
    card.addEventListener('click', function() {
      document.querySelectorAll('.platform-card').forEach(c => {
        c.classList.remove('selected');
        c.querySelector('.check-icon').classList.add('hidden');
      });
      this.classList.add('selected');
      this.querySelector('.check-icon').classList.remove('hidden');
      platformSelect.value = this.dataset.platform;
    });
  });

  // Set default selection
  document.querySelector('[data-platform="meesho"]').click();

  addTextCheckbox.addEventListener('change', (e) => {
    customTextInput.disabled = !e.target.checked;
    if (e.target.checked) customTextInput.focus();
  });

  marginSlider.addEventListener('input', (e) => marginDisplay.textContent = e.target.value + 'px');
  uploadArea.addEventListener('click', () => pdfInput.click());
  document.getElementById('browse-btn').addEventListener('click', (e) => { e.stopPropagation(); pdfInput.click(); });
  uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('border-blue-900', 'bg-blue-50'); });
  uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('border-blue-900', 'bg-blue-50'));
  uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('border-blue-900', 'bg-blue-50'); handleFiles(Array.from(e.dataTransfer.files)); });
  pdfInput.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));

  document.getElementById('clear-files-btn').addEventListener('click', () => {
    selectedFiles = []; pdfData = []; pdfInput.value = '';
    document.getElementById('file-list').classList.add('hidden');
    document.getElementById('pdf-viewer-section').classList.add('hidden');
    processBtn.disabled = true;
  });

  async function handleFiles(files) {
    const pdfFiles = files.filter(f => f.type === 'application/pdf');
    if (!pdfFiles.length) return alert('PDF files only');
    if (selectedFiles.length + pdfFiles.length > 10) return alert('Max 10 files');
    selectedFiles = [...selectedFiles, ...pdfFiles];
    updateFileList();
    await renderPDFPreviews();
  }

  function updateFileList() {
    const list = document.getElementById('file-list');
    const container = document.getElementById('files-container');
    if (!selectedFiles.length) return list.classList.add('hidden');
    list.classList.remove('hidden');
    document.getElementById('file-count').textContent = selectedFiles.length;
    container.innerHTML = selectedFiles.map((f, i) => `
      <div class="flex items-center justify-between bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-3 rounded-xl border-2 border-blue-200 hover:border-blue-900 transition-all">
        <div class="flex items-center space-x-3 flex-1 min-w-0">
          <i data-lucide="file-text" class="w-5 h-5 text-blue-900"></i>
          <div class="flex-1 min-w-0">
            <p class="font-bold text-blue-900 truncate text-sm">${f.name}</p>
            <p class="text-xs text-gray-500">${(f.size/1024).toFixed(1)} KB</p>
          </div>
        </div>
        <button onclick="removeFile(${i})" class="text-red-600 hover:bg-red-50 p-2 rounded-lg">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
    `).join('');
    lucide.createIcons();
  }

  window.removeFile = (i) => {
    selectedFiles.splice(i, 1);
    updateFileList();
    if (!selectedFiles.length) { document.getElementById('pdf-viewer-section').classList.add('hidden'); processBtn.disabled = true; }
    else renderPDFPreviews();
  };

  async function renderPDFPreviews() {
    const section = document.getElementById('pdf-viewer-section');
    const grid = document.getElementById('pdf-preview-grid');
    const loading = document.getElementById('loading-indicator');
    section.classList.remove('hidden');
    loading.classList.remove('hidden');
    grid.innerHTML = '';
    pdfData = [];

    for (let i = 0; i < selectedFiles.length; i++) {
      const file = selectedFiles[i];
      const ab = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: ab}).promise;
      const page = await pdf.getPage(1);
      const vp = page.getViewport({scale: 0.8});
      const cv = document.createElement('canvas');
      const ctx = cv.getContext('2d');
      cv.width = vp.width; cv.height = vp.height;
      await page.render({canvasContext: ctx, viewport: vp}).promise;
      pdfData.push({fileName: file.name, totalPages: pdf.numPages, fileSize: (file.size/1024).toFixed(1), preview: cv.toDataURL()});
      const card = document.createElement('div');
      card.className = 'pdf-viewer-card bg-white rounded-2xl shadow-xl p-4 border-2 border-blue-200';
      card.innerHTML = `
        <div class="relative mb-3">
          <img src="${cv.toDataURL()}" class="w-full rounded-xl border-2 border-blue-100">
          <div class="absolute top-2 right-2 bg-gradient-to-r from-blue-900 to-blue-600 text-white px-3 py-2 rounded-full text-xs font-bold shadow-lg">
            ${pdf.numPages} pg
          </div>
        </div>
        <div class="space-y-2">
          <p class="font-bold text-blue-900 truncate text-sm" title="${file.name}">${file.name}</p>
          <div class="flex justify-between text-xs bg-blue-50 rounded-lg p-2">
            <span class="text-gray-600">${(file.size/1024).toFixed(1)} KB</span>
            <span class="text-blue-600 font-bold">Ready</span>
          </div>
        </div>
      `;
      grid.appendChild(card);
    }
    loading.classList.add('hidden');
    document.getElementById('total-files').textContent = pdfData.length;
    processBtn.disabled = false;
    lucide.createIcons();
  }

  processForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!selectedFiles.length) {
      alert('Please upload at least one PDF');
      return;
    }

    const formData = new FormData();
    selectedFiles.forEach(file => formData.append('pdf', file));
    
    formData.append('mergePdf', document.getElementById('merge-pdf').checked);
    formData.append('addDateTime', document.getElementById('add-datetime').checked);
    formData.append('sortSku', document.getElementById('sort-sku').checked);
    formData.append('keepInvoice', document.getElementById('keep-invoice').checked);
    formData.append('addText', document.getElementById('add-text').checked);
    formData.append('customText', document.getElementById('custom-text').value);
    formData.append('multiOrders', document.getElementById('multi-orders').checked);
    formData.append('margin', document.getElementById('margin-slider').value);
    formData.append('platform', platformSelect.value);

    processBtn.disabled = true;
    document.getElementById('processing-status').classList.remove('hidden');

    try {
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        downloads.unshift({
          id: Date.now(),
          filename: result.filename,
          url: result.downloadUrl,
          date: new Date().toLocaleString()
        });
        
        if (downloads.length > 10) downloads.pop();
        localStorage.setItem('pdfDownloads', JSON.stringify(downloads));
        renderDownloads();
        
        alert('✅ PDF processed successfully! Check Downloads section.');
      } else {
        alert('❌ Error: ' + (result.message || 'Failed to process PDF'));
      }
    } catch (error) {
      console.error('Error:', error);
      alert('❌ Failed to process PDF: ' + error.message);
    } finally {
      processBtn.disabled = false;
      document.getElementById('processing-status').classList.add('hidden');
    }
  });

  function renderDownloads() {
    const list = document.getElementById('downloads-list');
    if (!downloads.length) {
      list.innerHTML = '<div class="text-center text-gray-400 py-16"><i data-lucide="inbox" class="w-20 h-20 mx-auto mb-3"></i><p class="font-semibold">No downloads</p></div>';
      lucide.createIcons();
      return;
    }
    
    list.innerHTML = downloads.map(d => `
      <div class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200 hover:border-blue-900 transition-all">
        <p class="font-bold text-blue-900 truncate text-sm mb-1">${d.filename}</p>
        <p class="text-xs text-gray-500 mb-3">${d.date}</p>
        <a href="${d.url}" download class="flex items-center justify-center space-x-2 gradient-bg text-white px-4 py-2 rounded-lg font-bold hover:shadow-lg transition-all">
          <i data-lucide="download" class="w-4 h-4"></i>
          <span>Download</span>
        </a>
      </div>
    `).join('');
    lucide.createIcons();
  }
  
  renderDownloads();
</script>

<%- include('footer') %>